/**
 * Core Philosophy: This ruleset enforces a strict, role-based security model for a maintenance management system.
 * Access is primarily determined by whether a user is an 'Admin' or a 'Manager', with specific exceptions for
 * user-owned data and assigned tasks. The default security posture is to deny access, granting permissions only
 * to authenticated users with the appropriate roles.
 *
 * Data Structure: The data is organized into top-level collections for 'users', 'assets', 'inventory', and 'reports'.
 * Maintenance requests are logically nested as a subcollection under the 'assets' they belong to. Roles are managed
 * in dedicated, client-inaccessible collections (`/roles_admin`, `/roles_manager`) for secure lookups within the rules.
 *
 * Key Security Decisions:
 * - User Listing Disabled: The `/users` collection cannot be listed by any client to protect user privacy.
 * - Role-Based Access: Most data management operations (creating assets, managing inventory, running reports) are
 *   restricted to users whose UID exists in a `/roles_manager` or `/roles_admin` document.
 * - Technician Updates: A non-manager user (e.g., a Technician) is explicitly granted permission to update a
 *   maintenance request *only if* their UID is in the `assignedTechnicianId` field of that request.
 * - Strict Ownership: A user's own profile document in `/users/{userId}` can only be created, modified, or deleted
 *   by that specific user. Admins are granted read-only access.
 *
 * Denormalization for Authorization: To ensure fast and secure authorization checks, this ruleset relies on the
 * existence of role-defining documents (e.g., `/roles_admin/{uid}`). A rule can perform a simple and efficient
 * `exists()` check against these paths instead of attempting slow and costly queries or joins. For example, to
 * check if a user is a manager, the rules look for a document at `/roles_manager/$(request.auth.uid)`.
 *
 * Structural Segregation: There is no mix of public and private data within collections, so structural segregation
 * is not required. Each collection has a uniform security requirement (e.g., all inventory is manager-only, all
 * assets are readable by any authenticated user).
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // =====================================================================
    // Helper Functions
    // =====================================================================

    /**
     * Authenticated Users
     * Checks if the user is signed in.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * Document Ownership
     * Checks if the authenticated user's UID matches the provided userId.
     */
    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    /**
     * Role Checks
     * These functions check for the existence of a document in a role-specific
     * collection. This is a secure and performant way to manage roles.
     * These collections should only be managed by a trusted server-side process.
     */
    function isAdmin() {
      return exists(/databases/$(database)/documents/roles_admin/$(request.auth.uid));
    }

    function isManager() {
      return exists(/databases/$(database)/documents/roles_manager/$(request.auth.uid));
    }

    function isManagerOrAdmin() {
      return isManager() || isAdmin();
    }

    /**
     * State Checks
     * Verifies that a document already exists. Crucial for update/delete operations.
     */
    function isExistingDoc() {
      return resource != null;
    }

    /**
     * Task-Specific Permissions
     * Checks if the requesting user is the technician assigned to the request.
     */
    function isAssignedTechnician() {
      return isExistingDoc() && resource.data.assignedTechnicianId == request.auth.uid;
    }

    /**
     * Prototyping Data Validation
     * These functions only validate fields critical for authorization and relational
     * integrity. They do not enforce the full data schema.
     */
    function hasValidUserProfileDataOnCreate(userId) {
      return request.resource.data.id == userId;
    }
    function hasImmutableUserProfileDataOnUpdate() {
      return request.resource.data.id == resource.data.id;
    }
    function hasValidAssetDataOnCreate(assetId) {
      return request.resource.data.id == assetId;
    }
    function hasValidRequestDataOnCreate(assetId, requestId) {
      return request.resource.data.id == requestId && request.resource.data.assetId == assetId;
    }
    function hasImmutableRequestDataOnUpdate() {
      return request.resource.data.id == resource.data.id && request.resource.data.assetId == resource.data.assetId;
    }
    function hasValidInventoryDataOnCreate(inventoryId) {
      return request.resource.data.id == inventoryId;
    }
    function hasValidReportDataOnCreate(reportId) {
      return request.resource.data.id == reportId;
    }


    // =====================================================================
    // Role Collections (Admin-managed)
    // =====================================================================

    /**
     * @description Defines admin users. This collection is a lookup table for security rules.
     *   It MUST NOT be writable by any client to prevent privilege escalation.
     * @path /roles_admin/{uid}
     * @allow (read/write) - No client access is permitted.
     * @deny (read/write) - Any client, regardless of role, trying to access this collection.
     * @principle Prevents client-side modification of authorization roles.
     */
    match /roles_admin/{uid} {
      allow get: if false;
      allow list: if false;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Defines manager users. This collection is a lookup table for security rules.
     *   It MUST NOT be writable by any client to prevent privilege escalation.
     * @path /roles_manager/{uid}
     * @allow (read/write) - No client access is permitted.
     * @deny (read/write) - Any client, regardless of role, trying to access this collection.
     * @principle Prevents client-side modification of authorization roles.
     */
    match /roles_manager/{uid} {
      allow get: if false;
      allow list: if false;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }


    // =====================================================================
    // Application Collections
    // =====================================================================

    /**
     * @description Manages user profile data.
     * @path /users/{userId}
     * @allow (create) - A new user creating their own profile document. `auth.uid` must match `{userId}`.
     * @allow (get, update, delete) - An existing user accessing their own profile. Admins can also read profiles.
     * @deny (list) - Any user trying to list all user profiles.
     * @deny (update) - A user trying to modify another user's profile.
     * @principle Restricts access to a user's own data tree and prevents user enumeration.
     */
    match /users/{userId} {
      allow get: if isOwner(userId) || isAdmin();
      allow list: if false;
      allow create: if isOwner(userId) && hasValidUserProfileDataOnCreate(userId);
      allow update: if isOwner(userId) && isExistingDoc() && hasImmutableUserProfileDataOnUpdate();
      allow delete: if isOwner(userId) && isExistingDoc();
    }

    /**
     * @description Manages asset information for the organization.
     * @path /assets/{assetId}
     * @allow (get, list) - Any authenticated user (e.g., technician, manager) can view asset information.
     * @allow (create, update, delete) - Only users with 'Manager' or 'Admin' roles can manage the asset catalog.
     * @deny (create) - A user without a manager or admin role trying to add an asset.
     * @principle Enforces role-based access for write operations while allowing reads for all internal users.
     */
    match /assets/{assetId} {
      allow get: if isSignedIn();
      allow list: if isSignedIn();
      allow create: if isManagerOrAdmin() && hasValidAssetDataOnCreate(assetId);
      allow update: if isManagerOrAdmin() && isExistingDoc();
      allow delete: if isManagerOrAdmin() && isExistingDoc();

      /**
       * @description Manages maintenance requests for a specific asset.
       * @path /assets/{assetId}/maintenanceRequests/{requestId}
       * @allow (get, list) - Any authenticated user can view the maintenance history of an asset.
       * @allow (update) - A Manager/Admin, or the specific technician assigned to the request.
       * @deny (update) - A technician trying to update a request they are not assigned to.
       * @deny (delete) - A technician trying to delete a maintenance request.
       * @principle Combines role-based permissions with document-specific permissions (assigned technician).
       */
      match /maintenanceRequests/{requestId} {
        allow get: if isSignedIn();
        allow list: if isSignedIn();
        allow create: if isManagerOrAdmin() && hasValidRequestDataOnCreate(assetId, requestId);
        allow update: if (isManagerOrAdmin() || isAssignedTechnician()) && isExistingDoc() && hasImmutableRequestDataOnUpdate();
        allow delete: if isManagerOrAdmin() && isExistingDoc();
      }
    }

    /**
     * @description Manages inventory of spare parts and supplies.
     * @path /inventory/{inventoryId}
     * @allow (read, write) - Only users with 'Manager' or 'Admin' roles can access or manage inventory.
     * @deny (read, write) - Any user who is not a manager or admin.
     * @principle Restricts access to sensitive operational data to authorized roles.
     */
    match /inventory/{inventoryId} {
      allow get: if isManagerOrAdmin();
      allow list: if isManagerOrAdmin();
      allow create: if isManagerOrAdmin() && hasValidInventoryDataOnCreate(inventoryId);
      allow update: if isManagerOrAdmin() && isExistingDoc();
      allow delete: if isManagerOrAdmin() && isExistingDoc();
    }

    /**
     * @description Manages generated system reports.
     * @path /reports/{reportId}
     * @allow (read, write) - Only users with 'Manager' or 'Admin' roles can access or manage reports.
     * @deny (read, write) - Any user who is not a manager or admin.
     * @principle Restricts access to potentially sensitive aggregate data to authorized roles.
     */
    match /reports/{reportId} {
      allow get: if isManagerOrAdmin();
      allow list: if isManagerOrAdmin();
      allow create: if isManagerOrAdmin() && hasValidReportDataOnCreate(reportId);
      allow update: if isManagerOrAdmin() && isExistingDoc();
      allow delete: if isManagerOrAdmin() && isExistingDoc();
    }
  }
}